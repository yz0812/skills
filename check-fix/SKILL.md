---
description: 对当前修改进行全面影响分析，检查是否对其他逻辑造成破坏，验证复杂数据结构的兼容性。触发方式：检查修复、影响分析、check fix。支持 --deep、--data、--breaking 选项。
allowed-tools: Read, Glob, Grep, Bash, mcp__ace-tool__search_context, mcp__server-git__git_diff_unstaged, mcp__server-git__git_diff_staged, mcp__serena__find_referencing_symbols
---

# 修复影响检查 (Fix Impact Analysis)

对当前修改进行全面影响分析，检查是否对其他逻辑造成破坏。

## 触发解析

| 参数 | 默认值 | 示例 |
|------|--------|------|
| 模式 | 标准分析 | --deep / --data / --breaking |
| 范围 | 当前修改 | 指定文件路径 |

解析示例:
- /check-fix 标准影响分析
- /check-fix --deep 深度分析
- /check-fix --data 数据结构兼容性
- /check-fix --breaking 仅检查破坏性变更

## 执行流程

### 1. 识别变更范围

优先使用 mcp__server-git__git_diff_unstaged 或 git_diff_staged 获取当前修改。
若无 git 变更，则询问用户指定文件。

### 2. 检查维度

#### 2.1 直接影响分析

必须检查:
- 修改的函数/方法被哪些地方调用
- 修改的参数签名是否向后兼容
- 返回值类型/结构是否发生变化
- 抛出的异常/错误类型是否变化
- 是否影响公共 API 契约

使用 ace-tool 搜索调用关系，或 serena 的 find_referencing_symbols。

#### 2.2 间接影响分析 (--deep 时执行)

必须追踪:
- 调用链上下游的数据流向
- 共享状态/全局变量的修改
- 事件监听器/回调函数的触发时机
- 缓存失效/更新策略
- 并发/异步操作的时序依赖

#### 2.3 数据结构兼容性 (--data 时重点)

必须验证:
- 新增字段: 旧数据读取时是否有默认值
- 删除字段: 是否有代码仍在访问该字段
- 类型变更: string到number、null到undefined 等隐式转换
- 嵌套结构: 深层对象的访问路径是否仍然有效
- 数组操作: 空数组、单元素、大数组的边界处理
- 可选字段: undefined vs null vs 缺失的区别处理

#### 2.4 边缘情况检查

必须考虑:
- 空值: null、undefined、空字符串、空数组、空对象
- 边界值: 0、-1、MAX_INT、空白字符
- 异常输入: 类型错误、格式错误、超长字符串
- 并发场景: 竞态条件、死锁、重复提交
- 网络异常: 超时、断连、重试

### 3. 生成报告

输出格式:

修复影响分析报告

变更摘要:
- 修改文件: 文件列表
- 修改类型: 新增/删除/重构/修复
- 影响范围: 局部/模块级/全局
- 风险等级: HIGH / MEDIUM / LOW

直接影响:
- 调用方列表及兼容性状态

数据结构兼容性:
- OK: 兼容的变更
- WARN: 需要迁移的变更
- FAIL: 破坏性变更

潜在风险点:
- 风险描述及建议处理方法

行动清单:
- HIGH 必须处理项
- MEDIUM 建议处理项
- LOW 可选优化项

## 常见问题模式

### 函数签名变更

危险: 删除参数、改变参数顺序、改变返回值类型
安全: 末尾添加可选参数、扩展返回值保留原有字段

### 数据结构变更

危险: 删除字段、重命名字段、改变字段类型
安全: 添加可选字段带默认值、扩展枚举值

### 异步行为变更

危险: 同步改异步、改变 Promise 解析时机
安全: 保持相同的异步模式、添加可选回调参数

## 注意事项

- 绝对禁止: 仅凭测试通过就认为修复安全
- 最佳实践: 动手前先用本命令评估影响范围
- 小步快跑: 大修改拆成多个小修改逐个验证
